generator client {
  provider   = "prisma-client-js"
  output     = "../node_modules/.prisma/client"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

model Asset {
  id              String      @id @default(dbgenerated("gen_random_uuid()"))
  name            String
  description     String?
  type            AssetType
  status          AssetStatus @default(OPERATIONAL)
  purchaseDate    DateTime?
  warrantyExpiry  DateTime?
  lastMaintenance DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime
  siteId          String
  unitId          String
  Site            Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)
  Unit            Unit        @relation(fields: [unitId], references: [id], onDelete: Cascade)
  WorkOrder       WorkOrder[]

  @@index([name])
  @@index([siteId])
  @@index([status])
  @@index([type])
  @@index([unitId])
}

model AuditLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  action    String
  details   Json?
  createdAt DateTime @default(now())
  userId    String
  User      User     @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId])
}

model Building {
  id          String      @id @default(dbgenerated("gen_random_uuid()"))
  name        String
  description String?
  address     String?
  city        String?
  state       String?
  zipCode     String?
  country     String?
  yearBuilt   Int?
  floors      Int?
  squareFeet  Int?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime
  siteId      String
  Site        Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)
  Unit        Unit[]
  WorkOrder   WorkOrder[]

  @@index([name])
  @@index([siteId])
}

model IPBlock {
  id             String        @id @default(dbgenerated("gen_random_uuid()"))
  ipAddress      String        @unique
  reason         String
  severity       String
  violationCount Int           @default(1)
  blockedBy      String?
  blockedAt      DateTime      @default(now())
  expiresAt      DateTime?
  organizationId String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  User           User?         @relation(fields: [blockedBy], references: [id])
  Organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([ipAddress])
  @@index([organizationId])
  @@index([severity])
}

model Organization {
  id                 String               @id @default(dbgenerated("gen_random_uuid()"))
  name               String               @unique
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  IPBlock            IPBlock[]
  OrganizationInvite OrganizationInvite[]
  Site               Site[]
  User               User[]
  WorkOrder          WorkOrder[]
  WorkOrderTemplate  WorkOrderTemplate[]

  @@index([name])
}

model OrganizationInvite {
  id              String       @id @default(dbgenerated("gen_random_uuid()"))
  email           String
  token           String       @unique
  status          InviteStatus @default(PENDING)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime
  expiresAt       DateTime
  organizationId  String
  invitedByUserId String
  User            User         @relation(fields: [invitedByUserId], references: [id], onDelete: Cascade)
  Organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([expiresAt])
  @@index([token])
}

model SecurityLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  ipAddress String
  userAgent String?
  action    String
  details   Json?
  severity  String   @default("INFO")
  userId    String?
  createdAt DateTime @default(now())
  User      User?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([ipAddress])
  @@index([severity])
}

model Session {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  token     String   @unique
  expiresAt DateTime
  userId    String
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
  @@index([userId])
}

model Site {
  id             String       @id @default(dbgenerated("gen_random_uuid()"))
  name           String
  address        String?
  city           String?
  state          String?
  zipCode        String?
  country        String?
  phoneNumber    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  organizationId String
  Asset          Asset[]
  Building       Building[]
  Organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  Unit           Unit[]
  WorkOrder      WorkOrder[]

  @@index([name])
  @@index([organizationId])
}

model Unit {
  id          String      @id @default(dbgenerated("gen_random_uuid()"))
  roomNumber  String
  name        String?
  floor       Int?
  squareFeet  Int?
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime
  siteId      String
  buildingId  String?
  Asset       Asset[]
  Building    Building?   @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  Site        Site        @relation(fields: [siteId], references: [id], onDelete: Cascade)
  WorkOrder   WorkOrder[]

  @@index([buildingId])
  @@index([roomNumber])
  @@index([siteId])
}

model User {
  id                                     String               @id @default(dbgenerated("gen_random_uuid()"))
  email                                  String               @unique
  password                               String
  recoveryPassphrase                     String? // For emergency password recovery
  passwordResetToken                     String?              @unique // One-time reset token
  passwordResetExpiresAt                 DateTime? // Token expiration
  firstName                              String?
  lastName                               String?
  phoneNumber                            String?
  role                                   UserRole             @default(TECHNICIAN)
  isActive                               Boolean              @default(true)
  createdAt                              DateTime             @default(now())
  updatedAt                              DateTime
  organizationId                         String?
  AuditLog                               AuditLog[]
  IPBlock                                IPBlock[]
  OrganizationInvite                     OrganizationInvite[]
  SecurityLog                            SecurityLog[]
  Session                                Session[]
  Organization                           Organization?        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  WorkOrder_WorkOrder_assignedToIdToUser WorkOrder[]          @relation("WorkOrder_assignedToIdToUser")
  WorkOrder_WorkOrder_createdByIdToUser  WorkOrder[]          @relation("WorkOrder_createdByIdToUser")
  WorkOrderEvent                         WorkOrderEvent[]
  WorkOrderComment                       WorkOrderComment[]   @relation("UserComments")
  CommentEdit                            CommentEdit[]        @relation("CommentEditUser")
  CommentMentionReceived                 CommentMention[]    @relation("MentionedUser")
  WorkOrderStatusHistory                 WorkOrderStatusHistory[] @relation("StatusHistoryUser")
  WorkOrderTemplate                      WorkOrderTemplate[]  @relation("TemplateCreator")

  @@index([email])
  @@index([organizationId])
  @@index([passwordResetToken])
  @@index([passwordResetExpiresAt])
}

model Waitlist {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  email     String   @unique
  name      String?
  company   String?
  role      String?
  phone     String?
  createdAt DateTime @default(now())
}

model WorkOrder {
  id                                String           @id @default(dbgenerated("gen_random_uuid()"))
  title                             String
  description                       String?
  priority                          Priority         @default(MEDIUM)
  status                            WorkOrderStatus  @default(PENDING)
  dueDate                           DateTime?
  completedAt                       DateTime?
  createdAt                         DateTime         @default(now())
  updatedAt                         DateTime
  assetId                           String?
  unitId                            String?
  buildingId                        String?
  siteId                            String?
  createdById                       String
  assignedToId                      String?
  organizationId                    String
  Asset                             Asset?           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  User_WorkOrder_assignedToIdToUser User?            @relation("WorkOrder_assignedToIdToUser", fields: [assignedToId], references: [id])
  Building                          Building?        @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  User_WorkOrder_createdByIdToUser  User             @relation("WorkOrder_createdByIdToUser", fields: [createdById], references: [id], onDelete: Cascade)
  Organization                      Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  Site                              Site?            @relation(fields: [siteId], references: [id], onDelete: Cascade)
  Unit                              Unit?            @relation(fields: [unitId], references: [id], onDelete: Cascade)
  WorkOrderEvent                    WorkOrderEvent[]
  WorkOrderComment                  WorkOrderComment[]
  WorkOrderStatusHistory            WorkOrderStatusHistory[]
  WorkOrderChecklistItem            WorkOrderChecklistItem[]

  @@index([assetId])
  @@index([assignedToId])
  @@index([createdById])
  @@index([dueDate])
  @@index([organizationId])
  @@index([priority])
  @@index([status])
  @@index([unitId])
}

model WorkOrderEvent {
  id          String    @id @default(dbgenerated("gen_random_uuid()"))
  event       String
  description String?
  createdAt   DateTime  @default(now())
  workOrderId String
  userId      String?
  User        User?     @relation(fields: [userId], references: [id])
  WorkOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([workOrderId])
}

model WorkOrderComment {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  content     String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isEdited    Boolean  @default(false)
  isDeleted   Boolean  @default(false)
  editedAt    DateTime?
  workOrderId String
  userId      String
  parentId    String?
  workOrder   WorkOrder          @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  user        User               @relation("UserComments", fields: [userId], references: [id], onDelete: Cascade)
  parent      WorkOrderComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     WorkOrderComment[] @relation("CommentReplies")
  mentions    CommentMention[]
  editHistory CommentEdit[]

  @@index([workOrderId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@index([isDeleted])
}

model CommentEdit {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  content   String   @db.Text
  editedAt  DateTime @default(now())
  commentId String
  userId    String
  comment   WorkOrderComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User             @relation("CommentEditUser", fields: [userId], references: [id])

  @@index([commentId])
  @@index([editedAt])
}

model CommentMention {
  id               String   @id @default(dbgenerated("gen_random_uuid()"))
  commentId        String
  mentionedUserId  String
  comment          WorkOrderComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  mentionedUser    User             @relation("MentionedUser", fields: [mentionedUserId], references: [id], onDelete: Cascade)

  @@index([commentId])
  @@index([mentionedUserId])
}

model WorkOrderStatusHistory {
  id          String           @id @default(dbgenerated("gen_random_uuid()"))
  fromStatus  WorkOrderStatus
  toStatus    WorkOrderStatus
  reason      String?
  createdAt   DateTime         @default(now())
  workOrderId String
  userId      String?
  workOrder   WorkOrder        @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  user        User?            @relation("StatusHistoryUser", fields: [userId], references: [id])

  @@index([workOrderId])
  @@index([createdAt])
}

model WorkOrderChecklistItem {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  title       String
  isCompleted Boolean  @default(false)
  position    Int      @default(0)
  workOrderId String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([position])
}

model WorkOrderTemplate {
  id             String      @id @default(dbgenerated("gen_random_uuid()"))
  name           String
  description    String?     @db.Text
  title          String?     // Default title for work orders from this template
  workDescription String?    @db.Text  // Default description
  priority       Priority    @default(MEDIUM)
  isGlobal       Boolean     @default(false)  // System-wide templates
  organizationId String?     // Null for global, set for org-specific
  isActive       Boolean     @default(true)
  usageCount     Int         @default(0)  // Track how many times used
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  createdBy      String

  Organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  Creator        User         @relation("TemplateCreator", fields: [createdBy], references: [id])
  TemplateItems  WorkOrderTemplateItem[]

  @@index([organizationId])
  @@index([isGlobal])
  @@index([isActive])
  @@index([organizationId, isActive])
}

model WorkOrderTemplateItem {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  title       String
  position    Int      @default(0)
  templateId  String
  template    WorkOrderTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([position])
}

enum AssetStatus {
  OPERATIONAL
  NEEDS_MAINTENANCE
  OUT_OF_SERVICE
}

enum AssetType {
  HVAC
  ELECTRICAL
  PLUMBING
  FIRE_SAFETY
  ELEVATOR
  SECURITY_SYSTEM
  OTHER
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  EMERGENCY
}

enum UserRole {
  ADMIN
  MANAGER
  TECHNICIAN
}

enum WorkOrderStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  ON_HOLD
  CANCELLED
}
